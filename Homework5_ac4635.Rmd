---
title: "Homework 5"
author: "JR Chansakul"
date: 2020-11-18
output: github_document
---

```{r setup, include = FALSE}
library(tidyverse)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 1

Read in the data.

```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```


Let's look at this a bit

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

Can I do a prop test for a single city?

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```

Try to iterate ........

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```


```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


```{r, error = TRUE}
city_prop_test = function(df) {
  
  prop.test(.....)
  
}
homicide_df = 
  read_csv("data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL") %>% 
  nest(data = resolved)
```


# Problem 2 


### Dataset Description:

This dataset contains information from a longitudinal study that included a control arm and an experimental arm. Data for each participant is included in a separate file, and file names include the subject ID and arm.
The 'map' function was used to iterate and read in all of the Excel files from the zipped folder.

Create a dataframe containing all file names, tidy the result, an d manipulate file names to include control arm and subject ID. Ensured weekly observations are “tidy”. 

```{r }

long_df = 
  tibble(
    path = list.files(path = "./lda_data")) %>%
 mutate(
   data = map(.x = str_c("lda_data/", path), ~read_csv(.x))
    ) %>% 
unnest(data) %>% 
separate(path, into = c("Arm", "ID", "csv")) %>%
  pivot_longer(
    week_1:week_8,
    names_to = "Week",
    names_prefix = "week_",
    values_to = "Observation"
    ) %>% 
select(-csv) %>% 
mutate(
  Arm = str_replace(Arm, "con", "Control"),
  Arm = str_replace(Arm, "exp", "Experiment")
  ) %>% 
arrange(Arm, ID)

long_df

```


### Spaghetti Plot:

Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.


```{r}
spag_plot = 
  long_df %>% 
  ggplot(aes(x = Week, y = Observation, group = interaction(Arm, ID), color = Arm)) + 
  geom_line(alpha=0.7) + 
  labs(
    x = "Week",
    y = "Observation",
    title = "Observations per Arm by week"
  )

spag_plot1 = 
  long_df %>% 
  ggplot(aes(x = Week, y = Observation,color = ID)) +
  geom_line(aes(group = ID)) +
  facet_grid(.~Arm) +
  labs(
    title = "Observations on each subject over time",
    x = "Week",
    y = "Observation"
  )

spag_plot
spag_plot1 
```
